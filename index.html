<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QuizArcade — 3D Runner + Games Hub</title>
  <meta name="description" content="Blooket-style hub: create quizzes (manual / AI) and play game modes. Includes a basic 3D runner (Three.js).">
  <style>
    :root{--accent:#ffcc00;--bg:#0b1220;--card:rgba(255,255,255,0.04);--muted:#9aa4b2}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#071225 0%, #0b1220 100%);color:#eaf2ff}
    .wrap{max-width:1200px;margin:18px auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;font-size:20px}
    .grid{display:grid;grid-template-columns:300px 1fr;gap:18px;margin-top:18px}
    .panel{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 8px 24px rgba(2,6,23,0.6)}
    button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#072;cursor:pointer;font-weight:600}
    .muted{color:var(--muted);font-size:13px}
    input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .small{font-size:13px;padding:6px}
    .game-canvas{width:100%;height:520px;background:#071225;border-radius:8px;display:block}
    .overlay{position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none}
    .ui-panel{position:absolute;right:28px;top:86px;width:320px;pointer-events:auto}
    .choices button{display:block;margin:8px 0;padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.06);color:#fff;cursor:pointer}
    .hidden{display:none}
    .flex{display:flex;gap:8px}
    footer{margin-top:12px;text-align:center;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>QuizArcade — Hub</h1>
        <div class="muted">Create a quiz (manual or AI), then choose a game mode. Try the 3D Runner!</div>
      </div>
      <div>
        <small class="muted">Static demo · AI requires a backend</small>
      </div>
    </header>

    <div class="grid">
      <aside class="panel">
        <div class="flex" style="margin-bottom:10px">
          <button id="btn-play">Play</button>
          <button id="btn-create">Create</button>
          <button id="btn-ai">Generate (AI)</button>
        </div>

        <div style="margin-bottom:10px">
          <label class="muted">Saved quizzes</label>
          <select id="quiz-list" size="6" style="height:220px"></select>
        </div>

        <div style="display:flex;gap:8px">
          <button id="start-game">Choose Game</button>
          <button id="delete-quiz">Delete</button>
        </div>

        <hr style="margin:12px 0;border-color:rgba(255,255,255,0.03)" />
        <div class="muted">Game Modes</div>
        <ul>
          <li>3D Runner (Temple Run–like)</li>
          <li>Memory Match</li>
          <li>Restaurant Rush (coming soon)</li>
        </ul>
      </aside>

      <main>
        <section id="view-play" class="panel">
          <div style="position:relative">
            <canvas id="gameCanvas" class="game-canvas"></canvas>
            <div class="overlay">
              <div id="game-ui" class="ui-panel hidden panel">
                <div class="muted" id="question-title">Question</div>
                <div id="question-text" style="font-weight:700;margin:8px 0"></div>
                <div id="choices" class="choices"></div>
                <div style="margin-top:8px" class="muted">Score: <span id="score">0</span> &nbsp; Lives: <span id="lives">3</span></div>
              </div>
            </div>
          </div>

          <div id="game-controls" style="margin-top:12px">
            <label class="muted">Mode:</label>
            <select id="mode-select" style="width:200px;margin-left:8px">
              <option value="runner">3D Runner</option>
              <option value="memory">Memory</option>
            </select>
            <button id="launch">Launch</button>
            <button id="stop" class="hidden">Stop</button>
          </div>
        </section>

        <section id="view-create" class="panel hidden">
          <h3>Create Quiz (Manual)</h3>
          <input id="quiz-title" placeholder="Quiz title (e.g. Ocean Class)" />
          <textarea id="manualInput" rows="8" placeholder="Type questions: Q: ... then four lines A) B) C) D) with * on the correct choice"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="save-quiz">Save</button>
            <button id="clear-builder">Clear</button>
          </div>
        </section>

        <section id="view-ai" class="panel hidden">
          <h3>Generate with AI</h3>
          <input id="ai-topic" placeholder="Topic (e.g., ocean animals)" />
          <input id="ai-count" type="number" min="1" max="20" value="5" style="width:120px" />
          <div style="margin-top:8px;display:flex;gap:8px"><button id="ai-generate">Generate</button><div id="ai-status" class="muted"></div></div>
        </section>

      </main>
    </div>

    <footer>Prototype — push this file as index.html to GitHub Pages. For AI generation, deploy a backend and set the fetch URL in the script.</footer>
  </div>

  <!-- Three.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
  <script>
  // --- Storage and quiz parsing ---
  const STORAGE_KEY = 'quizarcade_quizzes_v1';
  let quizzes = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  const lbKey = 'quizarcade_lb_v1';

  function saveQuizzes(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(quizzes)); }
  function refreshQuizList(){
    const sel = document.getElementById('quiz-list'); sel.innerHTML='';
    quizzes.forEach(q => { const o = document.createElement('option'); o.value=q.id; o.textContent=q.title; sel.appendChild(o); });
  }

  // parse manual input (flexible) — tries to find Q: and next 4 lines
  function parseManual(raw){
    const lines = raw.split('\n').map(s=>s.trim()).filter(s=>s!=='');
    const questions = [];
    for(let i=0;i<lines.length;){
      if(lines[i].toUpperCase().startsWith('Q:')){
        const q = lines[i].slice(2).trim();
        const choices = [];
        let answer = 0;
        for(let j=1;j<=4;j++){
          const ln = (lines[i+j]||'').replace(/^([A-Da-d]\)|[A-Da-d]\)/,'').trim();
          const isCorrect = ln.endsWith('*');
          choices.push(isCorrect ? ln.slice(0,-1).trim() : ln);
          if(isCorrect) answer = j-1;
        }
        questions.push({question:q,choices,answer});
        i += 5;
      } else { i++; }
    }
    return questions;
  }

  // UI wiring
  document.getElementById('btn-play').addEventListener('click', ()=>showTab('play'));
  document.getElementById('btn-create').addEventListener('click', ()=>showTab('create'));
  document.getElementById('btn-ai').addEventListener('click', ()=>showTab('ai'));
  function showTab(t){ document.getElementById('view-play').classList.toggle('hidden', t!=='play'); document.getElementById('view-create').classList.toggle('hidden', t!=='create'); document.getElementById('view-ai').classList.toggle('hidden', t!=='ai'); }

  document.getElementById('save-quiz').addEventListener('click', ()=>{
    const title = document.getElementById('quiz-title').value.trim() || ('Quiz '+(new Date()).toLocaleString());
    const raw = document.getElementById('manualInput').value;
    const questions = parseManual(raw);
    if(!questions.length) return alert('No questions parsed. Use Q: then four choices (mark correct with *).');
    const quiz = { id:'q_'+Date.now(), title, questions };
    quizzes.push(quiz); saveQuizzes(); refreshQuizList(); alert('Saved quiz!');
    document.getElementById('manualInput').value=''; document.getElementById('quiz-title').value='';
  });
  document.getElementById('clear-builder').addEventListener('click', ()=>{ document.getElementById('manualInput').value=''; document.getElementById('quiz-title').value=''; });

  document.getElementById('delete-quiz').addEventListener('click', ()=>{
    const sel = document.getElementById('quiz-list'); if(!sel.value) return alert('Select a quiz');
    if(!confirm('Delete selected quiz?')) return; quizzes = quizzes.filter(q=>q.id!==sel.value); saveQuizzes(); refreshQuizList();
  });

  document.getElementById('ai-generate').addEventListener('click', async ()=>{
    const topic = document.getElementById('ai-topic').value.trim(); const num = Number(document.getElementById('ai-count').value)||5;
    if(!topic) return alert('Enter a topic');
    document.getElementById('ai-status').textContent='Generating...';
    try{
      // NOTE: replace /api/generate with your deployed backend URL
      const resp = await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({topic,numQuestions:num})});
      if(!resp.ok) throw new Error('Server error '+resp.status);
      const data = await resp.json();
      const quiz = { id:'ai_'+Date.now(), title:'AI: '+topic, questions:data.questions };
      quizzes.push(quiz); saveQuizzes(); refreshQuizList(); document.getElementById('ai-status').textContent='Saved AI quiz';
    }catch(e){ console.error(e); document.getElementById('ai-status').textContent='Error: '+e.message; }
  });

  // load sample if empty
  if(!quizzes.length){ quizzes.push({ id:'sample1', title:'Ocean Basics', questions:[{question:'Which is a mammal?',choices:['Salmon','Dolphin','Tuna','Octopus'],answer:1},{question:'Coral type?',choices:['Brain coral','Seaweed','Kelp','Barnacle'],answer:0}] }); saveQuizzes(); }
  refreshQuizList();

  // --- Game Engine (Three.js) — basic 3D runner where obstacles move toward camera ---
  const canvas = document.getElementById('gameCanvas');
  const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
  const scene = new THREE.Scene();
  scene.fog = new THREE.FogExp2(0x071225, 0.02);
  const camera = new THREE.PerspectiveCamera(60,2,0.1,1000);
  camera.position.set(0,4,8);
  camera.lookAt(0,1.5,0);

  // lights
  const dir = new THREE.DirectionalLight(0xffffff, 0.8); dir.position.set(5,10,7); scene.add(dir);
  scene.add(new THREE.AmbientLight(0x404050,0.8));

  // ground
  const groundMat = new THREE.MeshStandardMaterial({color:0x2b3b2f});
  const groundGeo = new THREE.BoxGeometry(20,1,200);
  const ground = new THREE.Mesh(groundGeo, groundMat); ground.position.set(0,-1,0); scene.add(ground);

  // player
  const playerMat = new THREE.MeshStandardMaterial({color:0xffcc66});
  const playerGeo = new THREE.BoxGeometry(1,1.6,1);
  const player = new THREE.Mesh(playerGeo, playerMat); player.position.set(0,0.8,-4); scene.add(player);

  // obstacles container
  const obstacles = [];
  const obstacleGeo = new THREE.BoxGeometry(1.8,1.8,1.8);
  const obstacleMat = new THREE.MeshStandardMaterial({color:0xd94a4a});

  // runner state
  let lastTime = 0; let spawnTimer = 0; const spawnInterval = 1.2; let speed = 10; let paused = true;
  let score = 0; let lives = 3;

  // Question queue for gameplay
  let currentQuiz = null; let qIndex = 0;

  // resize
  function resize(){ const w = canvas.clientWidth; const h = canvas.clientHeight; if(canvas.width!==w||canvas.height!==h){ renderer.setSize(w,h,false); camera.aspect = w/h; camera.updateProjectionMatrix(); } }

  // spawn obstacle at z = 80
  function spawnObstacle(){ const m = new THREE.Mesh(obstacleGeo, obstacleMat.clone()); m.position.set((Math.random()*2-1)*3,0.9,80); scene.add(m); obstacles.push(m); }

  // Remove obstacle
  function removeObstacle(o){ scene.remove(o); const i = obstacles.indexOf(o); if(i!==-1) obstacles.splice(i,1); }

  // game loop
  function animate(t){ const dt = (t - lastTime)/1000 || 0; lastTime = t; if(!paused){ // move obstacles toward camera
      for(const ob of obstacles){ ob.position.z -= speed*dt; if(ob.position.z < -10){ removeObstacle(ob); // if pass behind camera - penalty
          lives -= 1; updateHUD(); if(lives<=0) endGame(); }
      }
      spawnTimer += dt; if(spawnTimer > spawnInterval){ spawnTimer = 0; spawnObstacle(); }
    }
    resize(); renderer.render(scene,camera); requestAnimationFrame(animate);
  }
  requestAnimationFrame(animate);

  // HUD update
  function updateHUD(){ document.getElementById('score').textContent = score; document.getElementById('lives').textContent = lives; }

  // Launch/Stop
  document.getElementById('launch').addEventListener('click', ()=>{
    const sel = document.getElementById('quiz-list'); if(!sel.value) return alert('Select a quiz first');
    currentQuiz = quizzes.find(q=>q.id===sel.value); if(!currentQuiz) return alert('Quiz not found');
    qIndex = 0; score = 0; lives = 3; updateHUD(); paused = false; document.getElementById('stop').classList.remove('hidden'); document.getElementById('launch').classList.add('hidden');
    // show question UI
    document.getElementById('game-ui').classList.remove('hidden');
    nextQuestion();
  });
  document.getElementById('stop').addEventListener('click', ()=>{ endGame(); });

  // Show question overlay
  function nextQuestion(){ if(!currentQuiz) return; if(qIndex >= currentQuiz.questions.length){ // loop or end
      qIndex = 0; }
    const q = currentQuiz.questions[qIndex]; document.getElementById('question-text').textContent = q.question; const choicesDiv = document.getElementById('choices'); choicesDiv.innerHTML='';
    q.choices.forEach((c,i)=>{ const btn = document.createElement('button'); btn.textContent = c; btn.addEventListener('click', ()=>answer(i)); choicesDiv.appendChild(btn); });
  }

  // Answer handler: correct -> clear nearest obstacle, add score and small speed boost; wrong -> lose life and screen shake
  function answer(i){ const q = currentQuiz.questions[qIndex]; const correct = (i === Number(q.answer)); if(correct){ score += 100; // clear nearest obstacle
    const nearest = obstacles.slice().sort((a,b)=>a.position.z - b.position.z)[0]; if(nearest) removeObstacle(nearest); speed = Math.min(speed + 0.5, 18);
  } else { lives -= 1; shakeCamera(); if(lives<=0) endGame(); }
    qIndex += 1; updateHUD(); nextQuestion(); }

  function shakeCamera(){ const orig = camera.position.clone(); let t = 0; const id = setInterval(()=>{ t+=0.05; camera.position.x = orig.x + (Math.random()*2-1)*0.2; camera.position.y = orig.y + (Math.random()*2-1)*0.1; if(t>0.6){ clearInterval(id); camera.position.copy(orig); } }, 16); }

  function endGame(){ paused = true; document.getElementById('stop').classList.add('hidden'); document.getElementById('launch').classList.remove('hidden'); document.getElementById('game-ui').classList.add('hidden'); alert('Game Over! Score: '+score); }

  // Simple memory-mode placeholder (not 3D) — small implementation: flip to answer questions and match
  const memoryData = { active:false };
  document.getElementById('mode-select').addEventListener('change', (e)=>{ if(e.target.value==='memory'){ document.getElementById('game-ui').classList.remove('hidden'); document.getElementById('question-title').textContent='Memory Mode'; } else { document.getElementById('question-title').textContent='Question'; } });

  // keyboard: space to jump (manual override) — simulate correct answer
  window.addEventListener('keydown', (e)=>{ if(e.code==='Space' && !paused){ // jump
      // remove nearest obstacle
      const nearest = obstacles.slice().sort((a,b)=>a.position.z - b.position.z)[0]; if(nearest && nearest.position.z < 15){ removeObstacle(nearest); score += 20; updateHUD(); }
    } });

  // expose a tiny debug control
  window.__quizarcade = { spawnObstacle };
  </script>
</body>
</html>
